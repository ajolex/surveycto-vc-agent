<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      padding: 20px;
      margin: 0;
      color: #202124;
      box-sizing: border-box;
    }

    .header {
      margin-bottom: 20px;
    }

    .status-badge {
      display: inline-block;
      font-size: 11px;
      background: #e6f4ea;
      color: #137333;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: #1a73e8;
    }

    p {
      margin: 0 0 16px 0;
      font-size: 13px;
      color: #5f6368;
      line-height: 1.5;
    }

    .version-tag {
      background-color: #e8f0fe;
      color: #1967d2;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
      font-family: monospace;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #3c4043;
    }

    textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }

    textarea:focus {
      border-color: #1a73e8;
      outline: none;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 24px;
    }

    button {
      padding: 8px 24px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s;
    }

    .btn-cancel {
      background-color: white;
      color: #5f6368;
      border: 1px solid #dadce0;
    }

    .btn-cancel:hover {
      background-color: #f1f3f4;
      color: #202124;
    }

    .btn-submit {
      background-color: #1a73e8;
      color: white;
    }

    .btn-submit:hover {
      background-color: #1557b0;
      box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3);
    }

    .loading {
      display: none;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      flex-direction: column;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    .btn-agent {
      background-color: #fce8e6;
      color: #c5221f;
      font-size: 12px;
      padding: 6px 12px;
      border: 1px solid #f9d1ce;
      border-radius: 4px;
      margin-top: 5px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn-agent:hover {
      background-color: #fad2cf;
      cursor: pointer;
    }

    .agent-wrapper {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error-msg {
      color: #d93025;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
  </style>
</head>

<body>
  <div class="header">
    <h2>Deploy Form</h2>
    <p>This will log the current version <span id="version-display" class="version-tag">Loading...</span> to history
      and open SurveyCTO.</p>
  </div>

  <div class="form-group">
    <label for="message">Deployment Message *</label>
    <textarea id="message" placeholder="e.g. Updated skip logic for Q5..."></textarea>

    <div class="agent-wrapper">
      <button id="agent-btn" class="btn-agent" onclick="triggerAgent()">
        ✨ Ask Agent to Summarize
      </button>
    </div>

    <div id="error-msg" class="error-msg">Please enter a deployment message.</div>
  </div>

  <div class="buttons">
    <button class="btn-cancel" onclick="google.script.host.close()">Cancel</button>
    <button class="btn-submit" onclick="handleDeploy()">Proceed to SurveyCTO</button>
  </div>

  <div id="initial-loading" class="loading">
    <div class="spinner"></div>
    <div style="font-weight:500; color:#5f6368; margin-top:10px;">Wait lang, I'm working...</div>
    <div style="font-size:12px; color:#9aa0a6; margin-top:4px;">Comparing sheets & generating summary...</div>
  </div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div id="loading-text">Logging deployment...</div>
  </div>

  <script>
    let formIds = [];
    let currentVersion = '';
    let serverUrl = 'https://pspsicm.surveycto.com/main.html#Design';

    // Initialize
    window.onload = function () {
      // document.getElementById('initial-loading').style.display = 'flex'; // No initial blocking loading for Agent
      // Just basic loading? Maybe minimal.

      google.script.run
        .withSuccessHandler(data => {
          document.getElementById('initial-loading').style.display = 'none';

          if (data.success) {
            currentVersion = data.version;
            document.getElementById('version-display').textContent = data.version;
            formIds = [data.formId];
            if (data.serverUrl) serverUrl = data.serverUrl + '/main.html#Design';
          } else {
            document.getElementById('version-display').textContent = 'Error';
            alert('Error loading form details: ' + data.error);
          }
        })
        .withFailureHandler(err => {
          document.getElementById('initial-loading').style.display = 'none';
          alert("Script Error: " + err.message);
        })
        .getDeployPopupData();
    };

    function triggerAgent() {
      const btn = document.getElementById('agent-btn');
      const overlay = document.getElementById('initial-loading');

      btn.disabled = true;
      overlay.style.display = 'flex'; // Show the "Wait lang" overlay

      google.script.run
        .withSuccessHandler(data => {
          overlay.style.display = 'none';
          btn.disabled = false;

          if (data.success && data.aiSummary) {
            const msgBox = document.getElementById('message');
            msgBox.value = data.aiSummary;

            // Add visual cue if not already there
            const label = document.querySelector('label[for="message"]');
            if (!label.innerHTML.includes('AI Generated')) {
              label.innerHTML += ` <span class="status-badge">✨ AI Generated</span>`;
            }
          } else {
            alert("Agent returned no summary or error.");
          }
        })
        .withFailureHandler(err => {
          overlay.style.display = 'none';
          btn.disabled = false;
          alert("Agent Failure: " + err.message);
        })
        .getAgentAnalysis();
    }

    function handleDeploy() {
      const message = document.getElementById('message').value.trim();
      if (!message) {
        document.getElementById('error-msg').style.display = 'block';
        return;
      }

      document.getElementById('loading').style.display = 'flex';

      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            document.getElementById('loading-text').textContent = 'Redirecting...';

            // Try "Smart Redirect" via Extension First
            const targetUrl = serverUrl;

            // Post message to parent (which extension observes)
            window.top.postMessage({
              type: 'SURVEYCTO_OPEN_OR_FOCUS',
              url: targetUrl
            }, '*');

            // Fallback: If no extension, or if it takes too long, just close dialog.
            // Note: We can't reliable open window.open from sandbox without user gesture interaction immediately in this callback context sometimes
            // But usually in successHandler it's allowed.

            // We give a tiny delay for extension to pick it up, then we close
            setTimeout(() => {
              // Backup method: Force open if extension didn't handle it (we assume extension handles it silently)
              // Actually, let's just do both. If extension focuses, great. If we open new, it's a fallback.
              // To avoid double-opening, we rely on the extension logic or just let the user have two tabs if edge case.
              // Better: "Click here if not redirected" link?

              // Simpler: Just try to open.
              // But the requirement is "redirect to already open tab". 
              // We will trust the extension. If extension is missing, we need a fallback.

              // Let's fallback to window.open only if we think extension is missing. 
              // We can't know for sure.
              // Let's provide a button "Open SurveyCTO" that appears if nothing happens.

              document.body.innerHTML = `
                   <div style="text-align:center; padding: 20px;">
                     <h2 style="color:#137333">Deployment Logged!</h2>
                     <p>Opening SurveyCTO...</p>
                     <p style="font-size:12px; color:#666">If SurveyCTO didn't open, <a href="${targetUrl}" target="_blank" style="color:#1a73e8">click here</a>.</p>
                     <button onclick="google.script.host.close()" class="btn-cancel" style="margin-top:10px">Close</button>
                   </div>
                 `;

              // Attempt direct open as fallback
              const link = document.createElement('a');
              link.href = targetUrl;
              link.target = '_blank';
              link.click();

            }, 1000);

          } else {
            document.getElementById('loading').style.display = 'none';
            alert('Error logging: ' + result.message);
          }
        })
        .withFailureHandler(error => {
          document.getElementById('loading').style.display = 'none';
          alert('System Error: ' + error.message);
        })
        .logAndOpenDeploy({
          formId: formIds[0],
          version: currentVersion,
          message: message,
          serverUrl: serverUrl
        });
    }
  </script>
</body>

</html>